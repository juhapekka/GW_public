import*as _ from"./node_modules/three/build/three.module.js";import*as u from"./network.js";import*as I from"./gameLogic.js";let t=!1,d=new _.TextureLoader,i="kenttÃ¤1.png",c="JuhasSong.mp3",m="Starlighthorizon.mp3",p="main.png",g=new Audio(c),w=(g.loop=!0,g.preload="auto",.7),r=(g.volume=w,null),E=null,x=0,a=4,S=!1,V=!1,Y=null,K=null,b=null,C=!1,L=!1,J=!1,Q=!1,T=!1,Z=!1,ee=!1,te=!1,ae=!1,ne=null,A=!1,M=!1,h=null,oe=null,ie=null,re=!1,le=!1,se="",P=!1,de=!1,ce=3500,e=performance.now(),me=performance.now();let pe=40,ue=180,ge=1,he=50,ye=he/1e3,R=new _.Scene,O=new _.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),B=(O.position.set(0,20,0),O.lookAt(0,0,0),new _.WebGLRenderer({antialias:!0,canvas:document.getElementById("gameCanvas")})),z=(B.setSize(window.innerWidth,window.innerHeight),B.outputEncoding=_.sRGBColorSpace,{}),l={up:!1,left:!1,right:!1},k={},n,s,G,H=0,y=0,ve=0,fe=0,we,Ee,xe=null,Se=null,_e=null,Ie=!1,D=1,N=1,F={},be=[];function v(...e){t&&console.log(...e)}function Ce(...e){t&&console.warn(...e)}function Le(...e){console.error(...e)}let Te=new Set;function Ae(e){if(e){if(Te.has(e))return 1;if(Te.add(e),1e3<Te.size){var t;let e=0;for(t of Te)if(Te.delete(t),10<=++e)break}}}let Me=500,Pe=0,Re=0,U=new _.Scene,W,Oe=50,j,Be,ze,ke=100,Ge=.8,He=[],De=1.2,Ne=10,Fe=.2,Ue=100,We=120,je=3,$e,$,o,q,X=null,qe=null;function Xe(){var e=document.getElementById("touchControls");e&&(e.style.display="none")}function f(){Xe(),[document.getElementById("nameEntryScreen"),document.getElementById("generalLoadingIndicator"),document.getElementById("textureErrorText"),document.getElementById("tempWaitingText"),document.getElementById("queueStatusIndicator")].forEach(e=>{e&&(e.id&&["generalLoadingIndicator","textureErrorText","tempWaitingText","queueStatusIndicator"].includes(e.id)?e.parentElement===document.body&&document.body.removeChild(e):e.style.display="none")}),q&&(q.visible=!1),$&&($.visible=!1),X&&(U.remove(X),X.material.map?.dispose(),X.material.dispose(),X=null),qe&&(U.remove(qe),qe.material.dispose(),qe.geometry?.dispose(),qe=null),P=!1,M=!1}function Ve(e){v("ðŸŽ¨ UI Texture fully loaded: "+e),++x>=a&&(v("ðŸŽ¨âœ… All UI textures preloaded and ready!"),S=!0,!P||q&&q.visible||(v("All UI textures now ready, re-attempting to show main screen."),(e=document.getElementById("generalLoadingIndicator"))&&e.parentElement&&document.body.removeChild(e),ut(!0)))}function Ye(){if(I.getPlayerState()&&I.config&&0<I.config.ORIGINAL_CAVERN_WIDTH)return 1;if(C&&b&&L&&0!==H&&0!==y){var e={ACCELERATION:.8,MAX_SPEED:10,GRAVITY_PULL:.12,SHIP_BASE_WIDTH_TEXELS:30,SHIP_BASE_HEIGHT_TEXELS:30,SHIP_COLLISION_RADIUS_TEX:10,LANDING_ANGLE_TARGET:Math.PI,LANDING_ANGLE_THRESHOLD:Math.PI/4,BULLET_SPEED:160,BULLET_GRAVITY_FACTOR:41,BULLET_RADIUS_TEX:4,SHOT_COOLDOWN:200};let a={ACCELERATION:e.ACCELERATION/ge,MAX_SPEED:e.MAX_SPEED/ge,GRAVITY_PULL:e.GRAVITY_PULL/ge,SHIP_COLLISION_RADIUS_TEX:Math.round(e.SHIP_COLLISION_RADIUS_TEX/ge),LANDING_ANGLE_TARGET:e.LANDING_ANGLE_TARGET,LANDING_ANGLE_THRESHOLD:e.LANDING_ANGLE_THRESHOLD,BULLET_SPEED:e.BULLET_SPEED,BULLET_GRAVITY_FACTOR:e.BULLET_GRAVITY_FACTOR,BULLET_RADIUS_TEX:e.BULLET_RADIUS_TEX,SHOT_COOLDOWN:e.SHOT_COOLDOWN,FIXED_STEP_MS:he,SHIP_BASE_WIDTH_TEXELS:e.SHIP_BASE_WIDTH_TEXELS,SHIP_BASE_HEIGHT_TEXELS:e.SHIP_BASE_HEIGHT_TEXELS,ORIGINAL_CAVERN_WIDTH:H,ORIGINAL_CAVERN_HEIGHT:y,WALL_THRESHOLD:ue,myId:b},l={isPixelWall:(e,t)=>!_e||e<0||e>=H||t<0||t>=y||(t=4*(Math.floor(t)*H+Math.floor(e)),_e.data[3+t]>a.WALL_THRESHOLD),checkShipCollision:(a,n,o)=>{if(_e)for(let t=-o;t<=o;t++)for(let e=-o;e<=o;e++)if(t*t+e*e<=o*o){var i=Math.round(a+t),r=Math.round(n+e);if(l.isPixelWall(i,r))return!0}return!1}};return I.initialize(a,l,{onPlayerStateSend:e=>u.sendPlayerState(e),onBulletFiredSend:e=>u.sendMessage("bullet",e),onExhaustParticleCreate:e=>{var t=1e3/he,a=e.vx*t,t=e.vz*t,n=.5*(Math.random()-.5);ct({id:`${e.ownerId}_exhaust_${performance.now()}_`+Math.random().toString(16).slice(2,8),x:e.x,z:e.z,y:.15,vx:a,vz:t,vy:n,life:De,initialScale:Ne,finalScale:Fe,color:16776960},!1)},onExhaustParticleCreateNetwork:e=>{var t=Date.now();u.sendMessage("exhaust_particle",{id:e.ownerId+`_exhaust_${t}_`+Math.random().toString(16).slice(2,7),...e})},onTerrainCollision:e=>{var t;e.playerId===b&&(200<(t=Date.now())-Re&&(Re=t,u.sendMessage("ground_collision",e)),lt(e.x,e.z,e.radius))&&(Ie=!0)},onPlayerExploded:(e,t,a)=>{dt(t,a),k[e]&&(R.remove(k[e]),k[e].geometry?.dispose(),k[e].material?.dispose(),delete k[e]),e===b&&(u.sendMessage("player_exploded",{playerId:e}),v("Client: My ship exploded! Visuals will continue. Waiting for server's game_over signal."),ke=0,Z=!0)},onBulletDestroyed:(e,t,a,n,o)=>{F[e]&&(R.remove(F[e]),F[e].geometry.dispose(),F[e].material.dispose(),delete F[e]),"terrain_impact"===t&&void 0!==a&&void 0!==n&&void 0!==o&&lt(a,n,o)&&(Ie=!0)},onBulletHitPlayer:(e,t,a)=>{var n;a!==b&&t!==b||(n=Date.now())-Pe>Me&&(Pe=n,u.sendMessage("bullet_hit_player",{bulletId:e,hitPlayerId:t,ownerId:a}))},onPlayerEnergyChanged:(e,t)=>{ae||(e===b&&(ke=t),z[e]&&(z[e].energy=t))},onPlayerStatusChanged:(e,t,a)=>{z[e]&&(z[e].status=t),e===b&&"dying"===t&&0===a&&(e=I.getPlayerState())&&(v("Client: My player status changed to 'dying'. Triggering explosion effect."),dt(e.x,e.z,e.angle))}}),v("GameLogic initialized by client."),1}Ce("initializeCoreGameLogic: Prerequisites not met.",{configReceived:C,myId:b,texturesReady:L,ORIG_W:H})}function Ke(){var e,t,a;if(de&&J&&!Q)Q=!0,tt();else if(b&&J&&L&&C&&re&&le&&!T&&!A)if(Ye()){if(i&&!G)h||at();else if(f(),!T&&!A){ee=!1,f();var[n=!1]=[];if(St()&&(te&&!n?(v("Touch controls not shown because game started with keyboard."),Xe()):(n=document.getElementById("touchControls"))&&(n.style.display="grid",v("Touch controls shown."))),h&&(cancelAnimationFrame(h),h=null),b&&z[b]&&L&&(!C||!i||G)&&we&&Ee)if(Ye()){for(var o in Object.values(k).forEach(e=>{R.remove(e),e.geometry?.dispose(),e.material?.dispose()}),k)delete k[o];n=z[b];if(I.resetPlayer(n.x,n.z,n.angle,n.isLanded||!1),I.addOrUpdatePlayer(b,{...n,serverReportedLanded:n.isLanded||!1}),T=!0,r&&!r.paused&&(r.pause(),r.currentTime=0),v(`startGame: Attempting to play game audio: ${g.src}, audioReady: `+J),g.volume=w,J)g.currentTime=0,Je(g);else v("startGame: Game audio not ready, waiting for canplaythrough event.");st(),Object.keys(z).forEach(e=>{var t=z[e];!t||"playing"!==t.status&&"waiting"!==t.status||"disconnected_ingame"===t.status||(k[e]||ot(e),I.addOrUpdatePlayer(e,{...t,serverReportedLanded:t.isLanded||!1}))}),b&&z[b]&&!k[b]&&"disconnected_ingame"!==z[b].status&&ot(b),ie&&clearInterval(ie),ie=setInterval(it,he)}else console.error("startGame: GameLogic could not be initialized!"),yt("Error: Game core failed to start (startGame).",5e3),u.closeConnection(1e3,"Client: GameLogic failed in startGame");else console.error("startGame: Prerequisites not met!",{myId:b,serverPlayerExists:!!z[b],texturesReady:L,cavernPlaneExists:!!G,shipGeoExists:!!we}),yt("Critical error starting game. Please try again.",5e3),u.closeConnection(1e3,"Client: startGame prerequisites failed")}}else v("MaybeStart: GameLogic failed to initialize. Cannot start game yet.");else b&&J&&L&&C&&!re&&!T&&!A?M||(f(),(n=!0)?(f(),M=!0,g&&!g.paused&&vt(g,300),r&&!r.paused&&(r.pause(),r.currentTime=0),n=window.innerWidth,e=window.innerHeight,W?(W.left=-n/2,W.right=n/2,W.top=e/2,W.bottom=-e/2,W.updateProjectionMatrix()):(W=new _.OrthographicCamera(-n/2,n/2,e/2,-e/2,1,1e3)).position.z=10,$&&U.remove($),$e?.image?.complete?(t=new _.SpriteMaterial({map:$e,depthTest:!1,transparent:!0}),($=new _.Sprite(t)).center.set(.5,.5),t=n/e,(a=$e.image.width/$e.image.height)<t?$.scale.set(n,n/a,1):$.scale.set(e*a,e,1),$.position.z=1,U.add($),$.visible=!0):(t=document.getElementById("tempWaitingText"))||((t=document.createElement("div")).id="tempWaitingText",Object.assign(t.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"24px",zIndex:"150",backgroundColor:"rgba(0,0,0,0.7)",padding:"20px",borderRadius:"10px"}),t.textContent="Loading Resources...",document.body.appendChild(t))):(M=!1,$&&($.visible=!1),(n=document.getElementById("tempWaitingText"))&&n.parentElement&&document.body.removeChild(n))):!de||!L||P||C||T||A||M?!de||L||P||M||T||A||(a=document.getElementById("generalLoadingIndicator"))||"none"!==document.getElementById("nameEntryScreen").style.display||((a=document.createElement("div")).id="generalLoadingIndicator",Object.assign(a.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"24px",zIndex:"150",backgroundColor:"rgba(0,0,0,0.7)",padding:"20px",borderRadius:"10px"}),a.textContent="Loading Assets...",document.body.appendChild(a)):(f(),ut(!0))}function Je(t){t&&t.play().catch(e=>Ce("Audio play failed for:",t.src,e))}function Qe(){let e=g.volume,t=r?r.volume:w;g.volume=.01,r&&(r.volume=.01),Je(g),r&&Je(r),setTimeout(()=>{g.paused||(g.pause(),g.currentTime=0,g.volume=e),r&&!r.paused&&(r.pause(),r.currentTime=0,r.volume=t)},50),window.removeEventListener("pointerdown",Qe),window.removeEventListener("keydown",Qe)}g.addEventListener("canplaythrough",()=>{J=!0,de&&!Q&&(Q=!0,tt()),Ke()}),window.addEventListener("pointerdown",Qe,{once:!0}),window.addEventListener("keydown",Qe,{once:!0}),document.body.style.overflow="hidden";var Ze=new _.LoadingManager;Ze.onStart=(e,t,a)=>v(`ðŸŸ¡ Loading: ${e} (${t}/${a})`),Ze.onLoad=()=>{v("âœ… All textures loaded via manager!"),at()},Ze.onError=e=>console.error("âŒ Error loading "+e);let et=new _.TextureLoader(Ze);function tt(){n&&n.image||(n=et.load("alus.png")),C&&i&&(G&&(R.remove(G),G.geometry?.dispose(),G.material?.map?.dispose(),G.material?.dispose(),G=null),s&&(s.dispose(),s=null),xe=null,Se=null,_e=null,H=0,y=0,s=et.load(i,e=>{e.colorSpace=_.SRGBColorSpace,e.image?(H=e.image.naturalWidth,y=e.image.naturalHeight,v(`Texture ${i} loaded: ${H}x`+y)):console.error(`Texture ${i} image data missing after load.`)},void 0,e=>console.error(`Error loading ${i}: `+e))),$e&&$e.image||($e=et.load("waiting_for_opponent.png",e=>e.colorSpace=_.SRGBColorSpace)),o&&o.image||(o=et.load(p,e=>e.colorSpace=_.SRGBColorSpace))}function at(){if(T||A)h&&(cancelAnimationFrame(h),h=null);else{var t=[];o&&t.push(o),$e&&t.push($e),n&&t.push(n),C&&i&&s&&t.push(s);let e=t.every(e=>e&&e.image&&e.image.complete&&0<e.image.naturalWidth);if(C&&i&&s&&s.image&&(0===H||0===y)&&(H=s.image.naturalWidth,y=s.image.naturalHeight,0===H||0===y?(console.error(`Cavern texture ${i} dimensions are zero after final check.`),e=!1):v(`Cavern texture ${i} dimensions confirmed: ${H}x`+y)),e){h&&(cancelAnimationFrame(h),h=null),v("All textures confirmed ready in finalizeSetup."),we=new _.PlaneGeometry(30,30),n&&(n.minFilter=_.LinearFilter,n.magFilter=_.LinearFilter),Ee=new _.MeshBasicMaterial({map:n,transparent:!0,side:_.DoubleSide,alphaTest:.1,color:16777215,depthTest:!1});let e=!(C&&i);if(C&&i&&(0<H&&0<y?(nt(),G&&_e?e=!0:console.error("Cavern plane or collision data missing after createOrUpdateCavern.")):console.error("Cavern dimensions zero, cannot create cavern plane.")),L=e)v("Textures ready, attempting to initialize GameLogic."),Ye();else if(C&&i&&!e)return Ce("Cavern plane needed but not created, retrying finalizeSetup."),void(h=requestAnimationFrame(at));f(),!de||T||A?de||L:C||P||M||!L?Ke():ut(!0),Ke()}else v("FinalizeSetup: Not all textures ready, retrying..."),h=requestAnimationFrame(at)}}function nt(){if(s&&s.image&&s.image.complete&&0!==H){var e=H,t=y,a=O.position.y,n=_.MathUtils.degToRad(O.fov),n=2*Math.tan(n/2)*a,a=n*O.aspect,a=Math.max(a/e,n/t),n=pe/e,a=Math.max(a,n),n=(D=a*ge,N=a,e*D),a=t*D;if(ve=n,fe=a,G){G.geometry.dispose(),G.geometry=new _.PlaneGeometry(n,a),G.material.map?.dispose();var o=new _.CanvasTexture(xe);o.colorSpace=_.SRGBColorSpace,o.needsUpdate=!0,G.material.map=o,G.material.needsUpdate=!0}else{(xe=document.createElement("canvas")).width=e,xe.height=t,Se=xe.getContext("2d",{willReadFrequently:!0});try{Se.drawImage(s.image,0,0,e,t),_e=Se.getImageData(0,0,e,t)}catch(e){return void console.error("Error drawing/getting image data for cavern:",e)}o=new _.CanvasTexture(xe),e=(o.colorSpace=_.SRGBColorSpace,o.needsUpdate=!0,new _.MeshBasicMaterial({map:o,side:_.FrontSide,transparent:!1,alphaTest:.05})),t=new _.PlaneGeometry(n,a);(G=new _.Mesh(t,e)).rotation.x=-Math.PI/2,R.add(G)}G.position.set(n/2,0,a/2),Object.values(k).forEach(e=>e.scale.set(N,N,1)),Object.values(F).forEach(e=>{var t=(I.config?.BULLET_RADIUS_TEX||4)*N;e.scale.set(t,t,1)}),Ye()}else Ce("createOrUpdateCavern: Cavern texture or dimensions not ready.")}function ot(e){var t;we&&Ee?(k[e]&&(R.remove(k[e]),k[e].geometry?.dispose(),k[e].material?.dispose(),delete k[e]),(t=new _.Mesh(we,Ee.clone())).rotation.x=-Math.PI/2,t.position.y=.3,t.renderOrder=1,t.scale.set(N,N,1),t.name="ship_"+e,R.add(t),k[e]=t):console.error("addShip: ship geometry/material missing")}function it(){T&&b&&!A&&I.getPlayerState()&&(I.updateLocalPlayerPhysics(l,ye),I.updateBulletsPhysics(ye))}window.addEventListener("resize",()=>{var e,t,a=window.innerWidth,n=window.innerHeight;O.aspect=a/n,O.updateProjectionMatrix(),B.setSize(a,n),B.setPixelRatio(window.devicePixelRatio),L&&H&&C&&G&&(nt(),st()),W&&(W.left=-a/2,W.right=a/2,W.top=n/2,W.bottom=-n/2,W.updateProjectionMatrix(),M&&$?.material.map?.image&&(e=a/n,(t=$.material.map.image.width/$.material.map.image.height)<e?$.scale.set(a,a/t,1):$.scale.set(n*t,n,1)),P&&q?.material.map?.image&&(e=a/n,(t=q.material.map.image.width/q.material.map.image.height)<e?q.scale.set(a,a/t,1):q.scale.set(n*t,n,1)),A)&&X?.material.map?.image&&(e=a/n,(t=X.material.map.image.width/X.material.map.image.height)<e?X.scale.set(a,a/t,1):X.scale.set(n*t,n,1))}),window.addEventListener("keydown",e=>{var t=I.getPlayerState(),t=t?t.status:"playing";A||b&&("dying"===t||"exploded"===t)||("ArrowUp"===e.key?l.up=!0:"ArrowLeft"===e.key?l.left=!0:"ArrowRight"===e.key?l.right=!0:"Space"!==e.code&&" "!==e.key||I.getPlayerState()&&I.attemptShootLocalPlayer())}),window.addEventListener("keyup",e=>{A||("ArrowUp"===e.key?l.up=!1:"ArrowLeft"===e.key?l.left=!1:"ArrowRight"===e.key&&(l.right=!1))});function rt(){requestAnimationFrame(rt);var t=performance.now(),a=(t-e)/1e3;e=t;let o=I.getAllPlayerStatesForRender();var n=o?o[b]:null;if(A)W&&B&&(X?.visible||qe?.visible)&&(B.autoClear=!0,B.render(U,W));else if(T)if(b&&z[b]&&G&&n){0<be.length&&0<D&&0<N&&(be.forEach(e=>I.addBullet(e)),be.length=0),Object.keys(o).forEach(e=>{var t=o[e],a=k[e],n=z[e];!t||n&&"disconnected_ingame"===n.status?a&&(R.remove(a),a.geometry?.dispose(),a.material?.dispose(),delete k[e]):(a||!t||"playing"!==t.status&&"waiting"!==t.status&&"dying"!==t.status||ot(e),k[e]&&t&&(a=k[e],("exploded"!==t.status||e===b&&Z)&&(!n||"exploded_wait_for_game_over"!==n.status&&"lost_game"!==n.status)?"exploded"!==t.status&&(a.visible=!0,a.position.x=t.x*D,a.position.z=t.z*D,a.rotation.z=t.angle+Math.PI,a.scale.set(N,N,1),"dying"===t.status?(Math.min(1,t.dyingProgress),0==t.dyingProgress&&dt(t.x,t.z),a.visible=!1):16777215!==a.material.color.getHex()&&a.material.color.setHex(16777215)):a.visible=!1))});var i=a,r=Math.min(i,.05),l=(i=I.config?.GRAVITY_PULL||.12)/ye;for(let e=He.length-1;0<=e;e--){var s,d=He[e];d.life-=r,d.life<=0?(R.remove(d.mesh),d.mesh.material.dispose(),He.splice(e,1)):(s=(d.vx_texel_per_sec*=1-.2*r,d.vz_texel_per_sec*=1-.2*r,d.isExplosionParticle?(d.vy_world_per_sec-=20*l*r,d.py_world+=d.vy_world_per_sec*r,d.mesh.position.y=d.py_world):(d.vx_texel_per_sec+=8*(Math.random()-.5)*r,d.vz_texel_per_sec+=8*(Math.random()-.5)*r),d.px_texel+=d.vx_texel_per_sec*r,d.pz_texel+=d.vz_texel_per_sec*r,d.mesh.position.x=d.px_texel*D,d.mesh.position.z=d.pz_texel*D,Math.max(0,d.life/d.initialLife)),s=(d.mesh.material.opacity=.8*s,d.initialScale+(d.finalScale-d.initialScale)*(1-s)),d.mesh.scale.set(s,s,1))}ke=n?n.energy:0;var c,m=a;if(j&&W&&j.userData.particles){var p=j.geometry.attributes.position.array,u=j.geometry.attributes.color.array,g=.07*window.innerHeight,h=window.innerWidth/2-1.7*g,y=window.innerHeight/2-1.7*g,v=Math.floor(ke/100*Oe);for(let e=0;e<Oe;e++){var f,w,E,x=j.userData.particles[e];e<v?x.isCurrentlyFadingOut&&(x.isCurrentlyFadingOut=!1,x.fadeProgress=0):!x.isCurrentlyFadingOut&&x.fadeProgress<1&&(x.isCurrentlyFadingOut=!0,x.fadeProgress=0),!x.isCurrentlyFadingOut||x.fadeProgress<1?(x.mainAngle+=x.mainSpeed*m,x.twirlAngle+=x.twirlSpeed*m,x.mainAngle>2*Math.PI&&(x.mainAngle-=2*Math.PI),x.twirlAngle>2*Math.PI&&(x.twirlAngle-=2*Math.PI),f=x.twirlRadiusBase+Math.sin(3*x.twirlAngle)*x.twirlRadiusVar,p[3*e]=h+Math.cos(x.mainAngle)*g+Math.cos(x.twirlAngle)*f,p[3*e+1]=y+Math.sin(x.mainAngle)*g+Math.sin(x.twirlAngle)*f):(p[3*e]=1/0,p[3*e+1]=1/0),x.isCurrentlyFadingOut?(x.fadeProgress+=m/Ge,f=Math.min(1,x.fadeProgress),w=new _.Color,f<.5?w.lerpColors(x.originalColor,new _.Color(16777215),f/.5):(E=(f-.5)/.5,w.lerpColors(new _.Color(16777215),new _.Color(16711680),E)),w.toArray(u,3*e),1<=f&&(p[3*e]=1/0,u[3*e]=0,u[3*e+1]=0,u[3*e+2]=0)):x.originalColor.toArray(u,3*e)}j.geometry.attributes.position.needsUpdate=!0,j.geometry.attributes.color&&(j.geometry.attributes.color.needsUpdate=!0)}b&&n&&("exploded"!==n.status||Z)&&(i=n.x*D,a=n.z*D,S=_.MathUtils.degToRad(O.fov/2),c=O.position.y,c=(S=Math.tan(S)*c)*O.aspect,c=Math.max(c,Math.min(ve-c,i)),i=Math.max(S,Math.min(fe-S,a)),O.position.x=c,O.position.z=i,O.lookAt(c,0,i));let e=I.getBulletsForRender();var S=Object.keys(F);e.forEach(e=>{var t,a;F[e.id]?(F[e.id].position.x=e.x*D,F[e.id].position.z=e.z*D):(a=I.config?.BULLET_RADIUS_TEX||4,t=new _.SpriteMaterial({color:16777215,depthWrite:!1,depthTest:!1}),(t=new _.Sprite(t)).renderOrder=10,a=a*N,t.scale.set(a,a,1),t.position.set(e.x*D,.1,e.z*D),R.add(t),F[e.id]=t)}),S.forEach(t=>{e.find(e=>e.id===t)||F[t]&&(R.remove(F[t]),F[t].geometry.dispose(),F[t].material.dispose(),delete F[t])}),Ie&&(Se&&_e&&G?.material?.map instanceof _.CanvasTexture&&(Se.putImageData(_e,0,0),G.material.map.needsUpdate=!0),Ie=!1),t-me>=1e3/30&&(B.autoClear=!0,B.render(R,O),W&&B&&(j||M||q?.visible)&&(B.autoClear=!1,B.clearDepth(),B.render(U,W)),me=t)}else T&&!n&&L&&C&&b&&0<H&&Ye(),W&&B&&(j||$?.visible)&&(B.autoClear=!0,B.render(U,W)),Ce("Animate: Prerequisites for full game rendering missing.",{myId:b,cavernPlane:!!G,myLogicPlayerState:!!n});else M&&$?.visible||P&&q?.visible?(B.autoClear=!0,B.render(U,W)):(G&&L||B)&&(B.autoClear=!0,B.render(R,O))}function lt(n,o,e){if(_e&&H&&y){var i=_e.data;let a=!1;var r=e*e,l=Math.max(0,Math.floor(n-e)),s=Math.min(H-1,Math.ceil(n+e)),d=Math.max(0,Math.floor(o-e)),c=Math.min(y-1,Math.ceil(o+e));for(let t=d;t<=c;t++)for(let e=l;e<=s;e++){var m=e-n,p=t-o;m*m+p*p<=r&&(3+(m=4*(t*H+e))>=i.length||i[3+m]>ue&&(i[3+m]=0,a=!0))}return a}}function st(){W&&j&&(U.remove(j),j.geometry?.dispose(),j.material?.dispose(),j=null);var e=window.innerWidth,t=window.innerHeight,a=(W?(W.left=-e/2,W.right=e/2,W.top=t/2,W.bottom=-t/2,W.updateProjectionMatrix()):(W=new _.OrthographicCamera(-e/2,e/2,t/2,-t/2,1,1e3)).position.z=10,Be=new _.BufferGeometry,new Float32Array(3*Oe)),n=new Float32Array(3*Oe),o=(Be.setAttribute("position",new _.BufferAttribute(a,3)),Be.setAttribute("color",new _.BufferAttribute(n,3)),ze=new _.PointsMaterial({size:Math.max(3,.012*Math.min(e,t)),transparent:!0,blending:_.AdditiveBlending,depthTest:!1,vertexColors:!0}),(j=new _.Points(Be,ze)).frustumCulled=!1,U.add(j),j.userData.particles=[],new _.Color(65280));for(let e=0;e<Oe;e++)o.toArray(n,3*e),j.userData.particles.push({mainAngle:Math.random()*Math.PI*2,mainSpeed:.5+.5*Math.random(),twirlAngle:Math.random()*Math.PI*2,twirlSpeed:2+2*Math.random(),twirlRadiusBase:.01*window.innerHeight,twirlRadiusVar:.01*window.innerHeight*Math.random(),isCurrentlyFadingOut:!1,fadeProgress:0,originalColor:o.clone()});Be.attributes.color&&(Be.attributes.color.needsUpdate=!0)}function dt(t,a,n=0){if(!ae){ae=!0,v(`Triggering explosion at (${t}, ${a}) with ship angle `+n);for(let e=0;e<Ue;e++){var o=n+(Math.random()-.5)*(2*Math.PI),i=.5+1.5*Math.random(),i=We*i,r=Math.sin(o)*i,o=Math.cos(o)*i,i=(Math.random()-.4)*i*.3,l=.5*Ne,s=.5*Fe;ct({id:`explosion_${b||"remote"}_${performance.now()}_`+e,x:t,y:.2,z:a,vx:r,vz:o,vy:i,life:je*(.6+.8*Math.random()),initialScale:l,finalScale:s,color:(new _.Color).setHSL(.12*Math.random()+.03,.9,.5+.3*Math.random())},!0)}}}function ct(e,t=!1){var a,n,o;Ae(e.id)||(a=new _.SpriteMaterial({color:e.color||16776960,transparent:!0,opacity:.9,blending:_.AdditiveBlending,depthTest:!1}),a=new _.Sprite(a),n=e.initialScale,o=e.finalScale,n=n*(t?1:N),o=o*(t?1:N),a.scale.set(n,n,1),a.position.set(e.x*D,(e.y||.15)*N,e.z*D),a.renderOrder=t?2:0,R.add(a),He.push({id:e.id,mesh:a,px_texel:e.x,pz_texel:e.z,py_world:a.position.y,vx_texel_per_sec:e.vx,vz_texel_per_sec:e.vz,vy_world_per_sec:e.vy,life:e.life,initialLife:e.life,initialScale:n,finalScale:o,isExplosionParticle:t}))}function mt(n,o){if(A&&X?.visible&&"info"!==n)v("showEndScreen called but gameIsOver is already true and endScreenMesh visible for win/lose. Ignoring.");else{f(),A=!0,Z=!1,"win"!==n&&"lose"!==n||(ee=!0,v("showEndScreen: Setting isReturningToMenuAfterGame = true")),h&&(cancelAnimationFrame(h),h=null),oe&&(clearInterval(oe),oe=null);var i=window.innerWidth,r=window.innerHeight,l=(W?(W.left=-i/2,W.right=i/2,W.top=r/2,W.bottom=-r/2,W.updateProjectionMatrix()):(W=new _.OrthographicCamera(-i/2,i/2,r/2,-r/2,1,1e3)).position.z=10,new _.MeshBasicMaterial({color:0,transparent:!0,opacity:0})),s=new _.PlaneGeometry(i,r);if((qe=new _.Mesh(s,l)).position.z=5,U.add(qe),qe.visible=!0,"info"===n){var d=document.createElement("canvas"),c=d.getContext("2d"),m=(d.width=512,d.height=256,c.font="Bold 30px Arial",c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",(o||"Session Ended").split(" "));let t="",a=d.height/2-20*(30<m.join(" ").length?1:0);for(let e=0;e<m.length;e++){var p=t+m[e]+" ";c.measureText(p).width>.9*d.width&&0<e?(c.fillText(t,d.width/2,a),t=m[e]+" ",a+=35):t=p}c.fillText(t,d.width/2,a);s=new _.CanvasTexture(d),l=(X&&(U.remove(X),X.material.map?.dispose(),X.material.dispose(),X=null),new _.SpriteMaterial({map:s,transparent:!0,opacity:0,depthTest:!1})),s=((X=new _.Sprite(l)).center.set(.5,.5),i/r),l=d.width/d.height;l<s?X.scale.set(r*l*.8,.8*r,1):X.scale.set(.8*i,i/l*.8,1),X.position.z=6,U.add(X),X.visible=!0}else{var s="lose"===n?K:Y;s&&s.image&&s.image.complete?(X&&(U.remove(X),X.material.map?.dispose(),X.material.dispose(),X=null),l=new _.SpriteMaterial({map:s,transparent:!0,opacity:0,depthTest:!1}),(X=new _.Sprite(l)).center.set(.5,.5),(l=s.image.width/s.image.height)<i/r?X.scale.set(i,i/l,1):X.scale.set(r*l,r,1),X.position.z=6,U.add(X),X.visible=!0):(Ce(`showEndScreen: ${n} screen texture not yet preloaded or not complete. Displaying temporary text.`),X&&(U.remove(X),X.material.map?.dispose(),X.material.dispose(),X=null),l=(s=document.createElement("canvas")).getContext("2d"),s.width=512,s.height=128,l.font="Bold 40px Arial",l.fillStyle="white",l.textAlign="center",l.textBaseline="middle",l.fillText("lose"===n?"DEFEAT":"VICTORY!",s.width/2,s.height/2),l=new _.CanvasTexture(s),l=new _.SpriteMaterial({map:l,transparent:!0,opacity:0,depthTest:!1}),(X=new _.Sprite(l)).center.set(.5,.5),(l=s.width/s.height)<i/r?X.scale.set(r*l*.7,.7*r,1):X.scale.set(.7*i,i/l*.7,1),X.position.z=6,U.add(X),X.visible=!0,setTimeout(()=>{A&&"info"!==n&&(v(`Retrying showEndScreen for ${n} as texture might be ready now.`),mt(n,o))},500))}let e=0,t=g.volume,a=g.volume;oe=setInterval(()=>{e+=.02,qe&&(qe.material.opacity=Math.min(.7,.7*e)),X?.material&&(X.material.opacity=Math.min(1,1.5*e)),.05<g.volume?g.volume=Math.max(0,t-e*a):(g.volume=0,g.paused||g.pause()),1<=e&&g.volume<=.05&&(clearInterval(oe),oe=null,g.paused||(g.pause(),g.currentTime=0,g.volume=a),setTimeout(()=>u.closeConnection(1e3,"Game ended, client returning to main screen"),2e3))},30)}}function pt(){te=!1,ee=!1;var e=document.getElementById("nameEntryScreen");let t=document.getElementById("playerNameInput"),a=document.getElementById("continueButton"),n=document.getElementById("nameError");V||(V=!0,x=0,S=!1,v("ðŸŽ¨ Preloading UI textures START..."),o=d.load(p,e=>{e.colorSpace=_.SRGBColorSpace,Ve(p)},void 0,e=>{console.error(`Error loading ${p}: `+e),Ve(p)}),$e=d.load("waiting_for_opponent.png",e=>{e.colorSpace=_.SRGBColorSpace,Ve("waiting_for_opponent.png")},void 0,e=>{console.error("Error loading waiting_for_opponent.png: "+e),Ve("waiting_for_opponent.png")}),Y=d.load("you_win.png",e=>{e.colorSpace=_.SRGBColorSpace,Ve("you_win.png")},void 0,e=>{console.error("Error loading you_win.png: "+e),Ve("you_win.png")}),K=d.load("you_lose.png",e=>{e.colorSpace=_.SRGBColorSpace,Ve("you_lose.png")},void 0,e=>{console.error("Error loading you_lose.png: "+e),Ve("you_lose.png")})),e&&t&&a&&n?(I.resetAll(),f(),e.style.display="flex",de=!1,T=!1,A=!1,C=!1,ae=!1,Q=!1,re=!1,le=!1,b=null,z={},u.getSocketState()!==WebSocket.CLOSED&&u.getSocketState()!==WebSocket.CLOSING&&u.closeConnection(1e3,"Client returning to name entry"),r&&!r.paused&&(r.pause(),r.currentTime=0),g&&!g.paused&&(g.pause(),g.currentTime=0),t.value=se||"",0<(e=t.value.trim()).length&&e.length<=10?(a.disabled=!1,n.textContent=""):(a.disabled=!0,0===e.length&&""!==t.value?n.textContent="Please enter a valid name (1-10 chars).":10<e.length?n.textContent="Name too long (max 10 chars).":n.textContent="Please enter a name (1-10 chars)."),""===t.value&&(t.placeholder="Enter your name"),t.oninput=()=>{var e=t.value.trim();0<e.length&&e.length<=10?(a.disabled=!1,n.textContent=""):(a.disabled=!0,0===e.length&&""!==t.value?n.textContent="Please enter a valid name (1-10 chars).":10<e.length?n.textContent="Name too long (max 10 chars).":n.textContent="Please enter a name (1-10 chars).")},a.onclick=()=>{if(!a.disabled)if(se=t.value.trim())if(de=!0,_t(),L&&o?.image?.complete)f(),ut(!0);else{f();let e=document.getElementById("generalLoadingIndicator");e||((e=document.createElement("div")).id="generalLoadingIndicator",Object.assign(e.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"24px",zIndex:"150",backgroundColor:"rgba(0,0,0,0.7)",padding:"20px",borderRadius:"10px"}),document.body.appendChild(e)),e.textContent="Loading Visuals...",J&&!Q?(Q=!0,tt()):J&&Q}else n.textContent="Invalid name. Please try again.",a.disabled=!0}):console.error("Name entry screen HTML elements not found! Cannot setup name entry.")}function ut(e){if(e){f(),P=!0,g&&!g.paused&&vt(g,300),r||((r=new Audio(m)).loop=!0,r.preload="auto"),(r.paused||r.volume<.9*w)&&(r.currentTime=0,r.volume=w,Je(r));var e=window.innerWidth,t=window.innerHeight;if(W?(W.left=-e/2,W.right=e/2,W.top=t/2,W.bottom=-t/2,W.updateProjectionMatrix()):(W=new _.OrthographicCamera(-e/2,e/2,t/2,-t/2,1,1e3)).position.z=10,q&&(U.remove(q),q.material?.dispose(),q=null),o?.image?.complete){var a=new _.SpriteMaterial({map:o,depthTest:!1,transparent:!1}),a=((q=new _.Sprite(a)).center.set(.5,.5),e/t),n=o.image.width/o.image.height;n<a?q.scale.set(e,e/n,1):q.scale.set(t*n,t,1),q.position.z=0,U.add(q),q.visible=!0,window.addEventListener("keydown",gt,{once:!0}),window.addEventListener("pointerdown",gt,{once:!0})}else{let e=document.getElementById("textureErrorText");e||((e=document.createElement("div")).id="textureErrorText",Object.assign(e.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"red",fontSize:"20px",zIndex:"200",backgroundColor:"black",padding:"15px"}),document.body.appendChild(e)),e.textContent="Error: Main screen assets not loaded. Please refresh.",void(P=!1)}}else P=!1,q&&(q.visible=!1),window.removeEventListener("keydown",gt),window.removeEventListener("pointerdown",gt)}function gt(e){te="keydown"===e.type,"keydown"===e.type&&" "!==e.key&&"Space"!==e.code&&"Enter"!==e.key||(r&&!r.paused?vt(r,500,()=>{ut(!1),ht()}):(ut(!1),ht()))}function ht(){if(!L||!$e?.image?.complete){f();let e=document.getElementById("generalLoadingIndicator");e||((e=document.createElement("div")).id="generalLoadingIndicator",Object.assign(e.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"24px",zIndex:"150",backgroundColor:"rgba(0,0,0,0.7)",padding:"20px",borderRadius:"10px"}),document.body.appendChild(e)),e.textContent="Connecting..."}u.initializeNetwork({onOpen:ft,onMessage:wt,onClose:Et,onError:xt},se),u.connect()}function yt(e,t){let a=document.getElementById("temporaryMessage");a||((a=document.createElement("div")).id="temporaryMessage",Object.assign(a.style,{position:"absolute",top:"40%",left:"50%",transform:"translate(-50%, -50%)",padding:"20px",backgroundColor:"rgba(0,0,0,0.85)",color:"white",fontSize:"24px",borderRadius:"10px",zIndex:"250",textAlign:"center",boxShadow:"0 0 15px rgba(255,255,255,0.5)"}),document.body.appendChild(a)),a.textContent=e,a.style.display="block",setTimeout(()=>{a&&a.parentElement&&(a.style.display="none")},t)}function vt(a,n,o){if(!a||a.paused&&0===a.volume)o&&o();else if(a.isFadingOut)o&&setTimeout(o,n);else{E&&a!==window.audioBeingFaded&&clearInterval(E),(window.audioBeingFaded=a).isFadingOut=!0;let e=a.volume;n=Math.max(1,n/30);let t=e/n;n<=0||t<=0&&.05<e?(a.volume=0,a.paused||a.pause(),a.currentTime=0,a.isFadingOut=!1,delete window.audioBeingFaded,o&&o()):E=setInterval(()=>{(e-=t)<=.05?(a.volume=0,a.pause(),a.currentTime=0,clearInterval(E),E=null,a.isFadingOut=!1,delete window.audioBeingFaded,o&&o()):a.volume=e},30)}}function ft(e){let t=document.getElementById("generalLoadingIndicator");t?t.textContent="Connection established. Waiting for server data...":P||M||T||"none"!==document.getElementById("nameEntryScreen").style.display||(f(),(t=document.createElement("div")).id="generalLoadingIndicator",Object.assign(t.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"24px",zIndex:"150",backgroundColor:"rgba(0,0,0,0.7)",padding:"20px",borderRadius:"10px"}),t.textContent="Connection established. Waiting for server data...",document.body.appendChild(t)),Ke()}function wt(t){var e,a;if("status_update"!==t.type&&"queue_update"!==t.type&&"name_received_in_queue"!==t.type&&((n=document.getElementById("generalLoadingIndicator"))&&n.parentElement&&document.body.removeChild(n),n=document.getElementById("queueStatusIndicator"))&&n.parentElement&&document.body.removeChild(n),"status_update"===t.type||"queue_update"===t.type){var n=document.getElementById("generalLoadingIndicator");n&&n.parentElement&&document.body.removeChild(n);let e=document.getElementById("queueStatusIndicator");e||!("queue_update"===t.type||"status_update"===t.type&&t.message.toLowerCase().includes("waiting for opponent"))||"none"!==document.getElementById("nameEntryScreen").style.display||T||P||(f(),(e=document.createElement("div")).id="queueStatusIndicator",Object.assign(e.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"24px",zIndex:"150",backgroundColor:"rgba(0,0,0,0.7)",padding:"20px",borderRadius:"10px",textAlign:"center"}),document.body.appendChild(e)),void(e?e.textContent=t.message+(t.position?` (Position: ${t.position}/${t.total})`:""):P&&"queue_update"===t.type&&yt(t.message+(t.position?` (Pos: ${t.position}/${t.total})`:""),5e3))}else if("name_received_in_queue"!==t.type)if(t.myId&&!b&&(b=t.myId,Ye(),I.setMyId(b)),t.config)ge,C=!0,i=t.config.map,ge=t.config.scale,t.config.music&&t.config.music!==c&&(v("Client: Game music filename set to "+(c=t.config.music)),J=!1,g.src=c,g.addEventListener("canplaythrough",()=>{J=!0,v(`ðŸ”Š Game audio ('${g.src}') ready (inline handler).`),T&&!A&&Je(g),Ke()},{once:!0}),g.networkState!==HTMLMediaElement.NETWORK_NO_SOURCE&&g.networkState!==HTMLMediaElement.NETWORK_EMPTY&&g.networkState!==HTMLMediaElement.NETWORK_IDLE||(v("Manually calling gameAudio.load() due to networkState:",g.networkState),g.load())),L=!1,Q=!1,I.resetAll(),tt(),t.config.spawn&&(ne=t.config.spawn),I.getPlayerState()&&ne&&I.resetPlayer(ne.x,ne.z,Math.PI,z[b]?.isLanded||!1),Ke();else if(!A||"game_over_win"===t.type||"game_over_lose"===t.type||"session_ended"===t.type)if("game_started"===t.type)re=!0,t.initialPlayersState&&(z=t.initialPlayersState,le=!0,Object.keys(z).forEach(e=>{I.addOrUpdatePlayer(e,{...z[e],serverReportedLanded:z[e].isLanded||!1})})),t.opponentName&&b&&yt("You play against "+t.opponentName,2500),Ke();else{if("ship_exploded_at"!==t.type)return"exhaust_particle_create"===t.type?t.ownerId===b?void 0:(n=1e3/he,e=(t.vx||0)*n,n=(t.vz||0)*n,a=Math.random()-.4,void ct({id:t.id,x:t.x,z:t.z,y:.15,vx:e,vz:n,vy:a,life:De,initialScale:Ne,finalScale:Fe,color:16776960},!1)):"bullet"===t.type?Ae(t.id)?void 0:void(D&&N?I.addBullet(t):be.push(t)):void("bullet_hit_player"===t.type&&t.hitPlayerId===b?I.processPlayerHitByServer(t.hitPlayerId,t.damageAmount||25):"bullet_destroyed_by_hit"===t.type?(I.removeBullet(t.bulletId),F[t.bulletId]&&(R.remove(F[t.bulletId]),F[t.bulletId].geometry.dispose(),F[t.bulletId].material.dispose(),delete F[t.bulletId])):"terrain_damaged_at"===t.type?lt(t.x,t.z,t.radius)&&(Ie=!0):"game_over_lose"===t.type?t.playerId!==b||A||mt("lose"):"game_over_win"===t.type?t.winnerId!==b||A?A||mt("lose"):mt("win"):"session_ended"===t.type?A||mt("info",t.reason||"Session ended"):"object"!=typeof t||t.type||t.config||t.myId||(z=t,Object.keys(z).forEach(e=>{var t=z[e];I.addOrUpdatePlayer(e,{...t,serverReportedLanded:t.isLanded||!1}),e===b&&void 0!==t.energy&&(ke=t.energy),e===b&&void 0!==t.isLanded&&I.updatePlayerLandedStatusFromServer(t.isLanded)}),!le&&0<Object.keys(z).length&&z[b]&&(le=!0,Ke()),Object.keys(k).forEach(e=>{(!z[e]&&k[e]||"disconnected_ingame"===z[e]?.status&&k[e])&&(R.remove(k[e]),k[e].geometry?.dispose(),k[e].material?.dispose(),delete k[e],I.removePlayer(e))})));dt(t.x,t.z),k[t.playerId]&&t.playerId!==b&&setTimeout(()=>{k[t.playerId]&&(k[t.playerId].visible=!1)},ce)}}function Et(e){for(var t in v(`handleSocketClose called. Reason: ${e.reason}, Code: ${e.code}. isReturningToMenuAfterGame: `+ee),v(`handleSocketClose called. Reason: ${e.reason}, Code: `+e.code),h&&(cancelAnimationFrame(h),h=null),oe&&(clearInterval(oe),oe=null),ie&&(clearInterval(ie),ie=null),I.resetAll(),b=null,C=!1,L=!1,Q=!1,T=!1,M=!1,P=!1,re=!1,le=!1,Z=!1,ae=!1,ne=null,l.up=!1,l.left=!1,l.right=!1,ke=100,z={},g.paused||(g.pause(),g.currentTime=0),r&&!r.paused&&(r.pause(),r.currentTime=0),Object.values(k).forEach(e=>{e.parent&&R.remove(e),e.geometry?.dispose(),e.material?.dispose()}),k)delete k[t];for(var a in Object.values(F).forEach(e=>{e.parent&&R.remove(e),e.geometry?.dispose(),e.material?.dispose()}),F)delete F[a];be.length=0,j&&j.parent&&(U.remove(j),j.geometry?.dispose(),j.material?.dispose(),j=null),He.forEach(e=>{e.mesh&&e.mesh.parent&&(R.remove(e.mesh),e.mesh.material?.dispose())}),He.length=0,G&&G.parent&&(R.remove(G),G.geometry?.dispose(),G.material?.map?.dispose(),G.material?.dispose(),G=null),H=0,y=0,xe=null,Se=null,_e=null,f();e=ee;ee=!1,A=!1,e&&de&&S&&o?.image?.complete?(v("handleSocketClose: Returning to main screen after game."),ut(!0)):(v("handleSocketClose: Defaulting to name entry screen.",{returningAfterGame:e,playerNameEntered:de,allUITexturesReady:S,mainTexComplete:o?.image?.complete}),pt())}function xt(e){console.error("ðŸ”Œ FATAL WS Error (via callback):",e),yt("FATAL Connection error. Please refresh & check server.",7e3),u.closeConnection(1006,"Client-side processing of WebSocket error")}function St(){return"ontouchstart"in window||0<navigator.maxTouchPoints}function _t(){var e;document.fullscreenElement||(e=document.documentElement).requestFullscreen?.().catch(e=>Ce("FS fail: "+e.message))||e.webkitRequestFullscreen?.().catch(e=>Ce("FS fail: "+e.message))}if(window.onload=()=>{W||((W=new _.OrthographicCamera(-window.innerWidth/2,window.innerWidth/2,window.innerHeight/2,-window.innerHeight/2,1,1e3)).position.z=10),pt(),rt()},St()){let n=document.getElementById("touchControls"),o=(n&&n.parentElement&&document.body.removeChild(n),(n=document.createElement("div")).id="touchControls",Object.assign(n.style,{position:"absolute",bottom:"10px",left:"10px",right:"10px",height:"22vh",display:"grid",gridTemplateRows:"1fr 1fr",gridTemplateColumns:"1fr 1fr 1fr",gridTemplateAreas:"'left up right' 'left down right'",gap:"10px",zIndex:"10"}),{left:"left",up:"up",down:"down",right:"right"});Object.keys(o).forEach(t=>{let a=document.createElement("div");var e;Object.assign(a.style,{background:"rgba(128,128,128,0.5)",borderRadius:"10px",touchAction:"none",userSelect:"none",webkitUserSelect:"none",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"20px",color:"white",gridArea:o[t]}),"up"===(a.dataset.control=t)?(a.innerHTML="SHOOT",a.addEventListener("touchstart",e=>{e.preventDefault(),I.getPlayerState()&&I.attemptShootLocalPlayer(),a.style.background="rgba(100,100,100,0.7)"},{passive:!1}),a.addEventListener("touchend",()=>{a.style.background="rgba(128,128,128,0.5)"},{passive:!1})):"down"===t?(a.innerHTML="THRUST",a.addEventListener("touchstart",e=>{e.preventDefault(),l.up=!0,a.style.background="rgba(100,100,100,0.7)"},{passive:!1}),e=()=>{l.up=!1,a.style.background="rgba(128,128,128,0.5)"},a.addEventListener("touchend",e,{passive:!1}),a.addEventListener("touchcancel",e,{passive:!1})):(a.innerHTML=t.toUpperCase(),a.addEventListener("touchstart",e=>{e.preventDefault(),l[t]=!0,a.style.background="rgba(100,100,100,0.7)"},{passive:!1}),e=e=>{l[t]&&(e.preventDefault(),l[t]=!1,a.style.background="rgba(128,128,128,0.5)")},a.addEventListener("touchend",e,{passive:!1}),a.addEventListener("touchcancel",e,{passive:!1}),a.addEventListener("touchmove",e=>{e.preventDefault();e=e.touches[0],e=document.elementFromPoint(e.clientX,e.clientY);e!==a&&l[t]?(l[t]=!1,a.style.background="rgba(128,128,128,0.5)"):e!==a||l[t]||(l[t]=!0,a.style.background="rgba(100,100,100,0.7)")},{passive:!1})),n.appendChild(a)}),document.body.appendChild(n),document.body.addEventListener("pointerdown",_t,{once:!0})}"serviceWorker"in navigator&&(navigator.serviceWorker.register("/service-worker.js").then(e=>{e.addEventListener("updatefound",()=>v("ðŸ”§ New SW found"))}).catch(e=>console.error("ðŸš¨ SW Reg Failed:",e)),navigator.serviceWorker.addEventListener("controllerchange",()=>v("ðŸ”§ New SW controlling page.")));export{v as log,Ce as warn,Le as error};