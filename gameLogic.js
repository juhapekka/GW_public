import{log as _,warn as a}from"./client.js";let u={ACCELERATION:.8,MAX_SPEED:10,GRAVITY_PULL:.12,SHIP_BASE_WIDTH_TEXELS:30,SHIP_BASE_HEIGHT_TEXELS:30,SHIP_COLLISION_RADIUS_TEX:10,LANDING_ANGLE_TARGET:Math.PI,LANDING_ANGLE_THRESHOLD:Math.PI/4,BULLET_SPEED:160,BULLET_GRAVITY_FACTOR:7,BULLET_RADIUS_TEX:4,SHOT_COOLDOWN:200,FIXED_STEP_MS:50,ORIGINAL_CAVERN_WIDTH:0,ORIGINAL_CAVERN_HEIGHT:0,WALL_THRESHOLD:180,BULLET_GRAVITY_PER_STEP:0,myId:null},I={id:null,x:0,z:0,angle:Math.PI,velocityX:0,velocityZ:0,status:"playing",isLanded:!1,serverReportedLanded:!1,lastShotTime:0,dyingProgress:0,energy:100},P={},o=[],S={isPixelWall:(e,t)=>!1,checkShipCollision:(e,t,i)=>!1},T={onPlayerStateSend:e=>{},onBulletFiredSend:e=>{},onExhaustParticleCreate:e=>{},onTerrainCollision:e=>{},onPlayerExploded:(e,t,i)=>{},onBulletDestroyed:(e,t,i,n,a)=>{},onBulletHitPlayer:(e,t,i)=>{},onPlayerEnergyChanged:(e,t)=>{},onPlayerStatusChanged:(e,t,i)=>{},onExhaustParticleCreateNetwork:e=>{}};function e(e,t,i){(u={...u,...e}).BULLET_GRAVITY_PER_STEP=u.GRAVITY_PULL*u.BULLET_GRAVITY_FACTOR,S=t,T=i,I.id=u.myId,P={},o=[],_("GameLogic initialized with ID:",I.id,"and config:",u),I.id&&(P[I.id]={...I})}function t(e){I.id=e,(u.myId=e)&&!P[e]&&(P[e]={...I})}function i(e,t,i=Math.PI,n=!1){I.id?(I.x=e,I.z=t,I.angle=i,I.velocityX=0,I.velocityZ=0,I.status="playing",I.isLanded=n,I.serverReportedLanded=n,I.lastShotTime=0,I.dyingProgress=0,I.energy=100,P[I.id]={...I},T.onPlayerEnergyChanged(I.id,I.energy),T.onPlayerStatusChanged(I.id,I.status,I.dyingProgress)):a("GameLogic.resetPlayer: localPlayerState.id is null. Cannot reset.")}function n(e,t){var i;P[e]?((i=P[e]).x=(void 0!==t.x?t:i).x,i.z=(void 0!==t.z?t:i).z,i.angle=(void 0!==t.angle?t:i).angle,i.velocityX=void 0!==t.velocityX_texel?t.velocityX_texel:(void 0!==t.velocityX?t:i).velocityX,i.velocityZ=void 0!==t.velocityZ_texel?t.velocityZ_texel:(void 0!==t.velocityZ?t:i).velocityZ,i.status=t.status||i.status,i.energy=("number"==typeof t.energy?t:i).energy,i.isLanded=(void 0!==t.isLanded?t:i).isLanded,i.dyingProgress=(void 0!==t.dyingProgress?t:i).dyingProgress):P[e]={id:e,x:t.x||0,z:t.z||0,angle:void 0!==t.angle?t.angle:Math.PI,velocityX:t.velocityX_texel||t.velocityX||0,velocityZ:t.velocityZ_texel||t.velocityZ||0,status:t.status||"playing",energy:"number"==typeof t.energy?t.energy:100,isLanded:t.isLanded||!1,dyingProgress:t.dyingProgress||0},e===I.id&&(t.status&&t.status!==I.status&&(I.status=t.status,"dying"!==I.status?I.dyingProgress=0:I.dyingProgress=t.dyingProgress||0,T.onPlayerStatusChanged(I.id,I.status,I.dyingProgress)),"number"==typeof t.energy&&t.energy!==I.energy&&(I.energy=t.energy,T.onPlayerEnergyChanged(I.id,I.energy)),void 0!==t.isLanded)&&(I.serverReportedLanded=t.isLanded)}function l(e){delete P[e],e===I.id&&(I.id=null)}function d(){return I&&I.id?{...I}:null}function r(){var e,t={};for(e in P)e===I.id&&null!==I.id?t[e]={...P[e],...I}:t[e]={...P[e]};return I.id&&!t[I.id]&&(t[I.id]={...I}),t}function s(e){I.id&&(I.serverReportedLanded=e)}function y(o,l){if(I.id&&"exploded"!==I.status){var d=u.ACCELERATION,r=u.MAX_SPEED;let i=.96;let n=!1,a=!1;if("dying"===I.status)I.velocityX*=.95,I.velocityZ*=.95,I.x+=I.velocityX,I.z+=I.velocityZ,I.dyingProgress+=l/4,1<=I.dyingProgress&&(I.dyingProgress=1,I.status="exploded",T.onPlayerExploded(I.id,I.x,I.z)),T.onPlayerStatusChanged(I.id,I.status,I.dyingProgress);else if("playing"===I.status){let e=I.angle;for(;e<=-Math.PI;)e+=2*Math.PI;for(;e>Math.PI;)e-=2*Math.PI;var l=Math.abs(e-u.LANDING_ANGLE_TARGET),l=(a=Math.min(l,2*Math.PI-l)<=u.LANDING_ANGLE_THRESHOLD,.35*u.SHIP_BASE_WIDTH_TEXELS),s=.35*u.SHIP_BASE_HEIGHT_TEXELS,l=[{localDx:-l,localDz:-s},{localDx:l,localDz:-s}];let t=!0;var y,g,c=Math.cos(I.angle),v=Math.sin(I.angle);for(y of l){var E=y.localDx*c-y.localDz*v,L=y.localDx*v+y.localDz*c,E=Math.round(I.x+E),L=Math.round(I.z+L);if(!S.isPixelWall(E,L)){t=!1;break}}n=t,I.serverReportedLanded||n&&a&&Math.abs(I.velocityX)<.5&&Math.abs(I.velocityZ)<.5&&-.1<=I.velocityZ?I.isLanded=!0:I.isLanded=!1,o.up&&(_(`GameLogic: inputState.up=true. localPlayerState.isLanded=${I.isLanded}, serverReportedLanded=`+I.serverReportedLanded),I.isLanded?(I.velocityZ-=3.5*d,I.isLanded=!1,I.serverReportedLanded=!1):(I.velocityX+=Math.sin(I.angle)*d,I.velocityZ+=Math.cos(I.angle)*d,s=-Math.sin(I.angle)*(.5*u.SHIP_BASE_HEIGHT_TEXELS),l=-Math.cos(I.angle)*(.5*u.SHIP_BASE_HEIGHT_TEXELS),d=I.x+s,s=I.z+l,l=-I.velocityX+2*(Math.random()-.5),g=-I.velocityZ+2*(Math.random()-.5),T.onExhaustParticleCreate({ownerId:I.id,x:d,z:s,vx:l,vz:g}),T.onExhaustParticleCreateNetwork({type:"exhaust_particle",ownerId:I.id,x:d,z:s,vx:l,vz:g}))),I.isLanded||(o.left&&(I.angle+=.1),o.right&&(I.angle-=.1),r<(d=Math.sqrt(I.velocityX**2+I.velocityZ**2))&&(I.velocityX=I.velocityX/d*r,I.velocityZ=I.velocityZ/d*r)),I.isLanded?(i=.7,I.velocityX*=i,o.up?I.velocityZ*=i:(I.velocityZ=0,I.velocityX=0),Math.abs(I.velocityX)<.01&&!o.up&&(I.velocityX=0),Math.abs(I.velocityZ)<.01&&!o.up&&(I.velocityZ=0)):(I.velocityX*=i,I.velocityZ*=i,I.velocityZ+=u.GRAVITY_PULL),I.x+=I.velocityX,I.z+=I.velocityZ,I.isLanded||S.checkShipCollision(Math.round(I.x),Math.round(I.z),u.SHIP_COLLISION_RADIUS_TEX)&&(T.onTerrainCollision({playerId:I.id,x:Math.round(I.x),z:Math.round(I.z),radius:u.SHIP_COLLISION_RADIUS_TEX,velocityX:I.velocityX,velocityZ:I.velocityZ}),I.energy-=5,I.energy<0&&(I.energy=0,I.status="dying",I.dyingProgress=0,T.onPlayerStatusChanged(I.id,I.status,I.dyingProgress)),T.onPlayerEnergyChanged(I.id,I.energy),I.velocityX*=-.5,I.velocityZ*=-.5),I.x=Math.max(0,Math.min(u.ORIGINAL_CAVERN_WIDTH,I.x)),I.z=Math.max(0,Math.min(u.ORIGINAL_CAVERN_HEIGHT,I.z))}T.onPlayerStateSend({x:I.x,z:I.z,angle:I.angle,velocityX:I.velocityX,velocityZ:I.velocityZ,isLanded:I.isLanded,isOverFlatGround:n,angleOKForLanding:a}),P[I.id]?P[I.id]={...P[I.id],...I}:I.id&&(P[I.id]={...I})}}function g(){var e,t,i,n,a,o,l;!I.id||"playing"!==I.status||I.isLanded||(l=Date.now())-I.lastShotTime<u.SHOT_COOLDOWN||(I.lastShotTime=l,e=Math.sin(I.angle),t=Math.cos(I.angle),n=.75*u.SHIP_BASE_HEIGHT_TEXELS,i=I.x+e*n,n=I.z+t*n,a=I.velocityX/(u.FIXED_STEP_MS/1e3),o=I.velocityZ/(u.FIXED_STEP_MS/1e3),l={id:I.id+"_"+l,ownerId:I.id,x:i,z:n,angle:I.angle,vx:e*u.BULLET_SPEED+a,vz:t*u.BULLET_SPEED+o},T.onBulletFiredSend(l),c(l))}function c(t){o.find(e=>e.id===t.id)||o.push({...t})}function v(t){o=o.filter(e=>e.id!==t)}function E(t){for(let e=o.length-1;0<=e;e--){var i=o[e];if(i.vz+=u.BULLET_GRAVITY_PER_STEP,i.x+=i.vx*t,i.z+=i.vz*t,i.x<0||i.x>u.ORIGINAL_CAVERN_WIDTH||i.z<0||i.z>u.ORIGINAL_CAVERN_HEIGHT)T.onBulletDestroyed(i.id,"out_of_bounds"),o.splice(e,1);else if(S.isPixelWall(Math.round(i.x),Math.round(i.z)))T.onBulletDestroyed(i.id,"terrain_impact",Math.round(i.x),Math.round(i.z),u.BULLET_RADIUS_TEX),o.splice(e,1);else for(var n in P){var a=P[n];a&&"playing"===a.status&&n!==i.ownerId&&(i.x-a.x)**2+(i.z-a.z)**2<(.4*u.SHIP_BASE_WIDTH_TEXELS+u.BULLET_RADIUS_TEX)**2&&T.onBulletHitPlayer(i.id,n,i.ownerId)}}}function L(e,t=25){let i=null;e===I.id?i=I:P[e]&&(i=P[e]),i&&"playing"===i.status&&(i.energy-=t,i.energy<=0&&(i.energy=0,i.status="dying",i.dyingProgress=0,T.onPlayerStatusChanged(e,i.status,i.dyingProgress)),T.onPlayerEnergyChanged(e,i.energy),e===I.id)&&(I={...i})}function h(){return o.map(e=>({...e}))}function x(){var e=I.id;I={id:e,x:0,z:0,angle:Math.PI,velocityX:0,velocityZ:0,status:"playing",isLanded:!1,serverReportedLanded:!1,lastShotTime:0,dyingProgress:0,energy:100},P={},e&&(P[e]={...I}),o=[],_("GameLogic state reset.")}export{e as initialize,t as setMyId,i as resetPlayer,n as addOrUpdatePlayer,l as removePlayer,d as getPlayerState,r as getAllPlayerStatesForRender,s as updatePlayerLandedStatusFromServer,y as updateLocalPlayerPhysics,g as attemptShootLocalPlayer,c as addBullet,v as removeBullet,E as updateBulletsPhysics,L as processPlayerHitByServer,h as getBulletsForRender,x as resetAll};